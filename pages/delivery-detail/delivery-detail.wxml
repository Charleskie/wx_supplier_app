<!--pages/delivery-detail/delivery-detail.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="header">
    <view class="header-left">
      <text class="back-btn" bindtap="goBack">â†</text>
    </view>
    <view class="header-title">
      <text>{{isEdit ? 'ç¼–è¾‘é€è´§å•' : 'é€è´§å•è¯¦æƒ…'}}</text>
    </view>
    <view class="header-right">
      <text class="edit-btn" bindtap="toggleEdit" wx:if="{{!isEdit && deliveryId}}">ç¼–è¾‘</text>
      <text class="save-btn" bindtap="saveDelivery" wx:if="{{isEdit}}">ä¿å­˜</text>
    </view>
  </view>

  <!-- é€è´§å•åŸºæœ¬ä¿¡æ¯ -->
  <view class="delivery-info" wx:if="{{!isEdit}}">
    <view class="info-card">
      <view class="info-row">
        <text class="info-label">é€è´§å•å·ï¼š</text>
        <text class="info-value">{{delivery.deliveryNo}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">çŠ¶æ€ï¼š</text>
        <text class="status-tag {{delivery.status}}">{{deliveryStatusText}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">é…é€å‘˜ï¼š</text>
        <text class="info-value">{{delivery.employeeName}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">åˆ›å»ºæ—¶é—´ï¼š</text>
        <text class="info-value">{{delivery.createTime}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">æ€»é‡‘é¢ï¼š</text>
        <text class="info-value total-amount">Â¥{{delivery.totalAmount}}</text>
      </view>
    </view>
  </view>

  <!-- å®¢æˆ·é€‰æ‹©åŒºåŸŸ -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">å®¢æˆ·ä¿¡æ¯</text>
      <text class="add-btn" bindtap="showCustomerSelector" wx:if="{{isEdit}}">+ æ·»åŠ å®¢æˆ·</text>
    </view>
    
    <!-- å·²é€‰æ‹©çš„å®¢æˆ·åˆ—è¡¨ -->
    <view class="customer-list" wx:if="{{selectedCustomers.length > 0}}">
      <view 
        class="customer-item" 
        wx:for="{{selectedCustomers}}" 
        wx:key="id"
      >
        <view class="customer-info">
          <text class="customer-name">{{item.name}}</text>
          <text class="customer-phone">{{item.phone}}</text>
          <text class="customer-address">{{item.address}}</text>
        </view>
        <view class="customer-actions">
          <text class="remove-btn" bindtap="removeCustomer" data-index="{{index}}" wx:if="{{isEdit}}">åˆ é™¤</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:elif="{{isEdit}}">
      <text class="empty-icon">ğŸ‘¥</text>
      <text class="empty-text">è¯·é€‰æ‹©å®¢æˆ·</text>
      <text class="empty-subtext">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ å®¢æˆ·</text>
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">è®¢å•ä¿¡æ¯</text>
      <text class="add-btn" bindtap="showOrderCreator" wx:if="{{isEdit}}">+ æ·»åŠ è®¢å•</text>
    </view>
    
    <!-- è®¢å•åˆ—è¡¨ -->
    <view class="order-list" wx:if="{{orders.length > 0}}">
      <!-- æŒ‰å®¢æˆ·åˆ†ç»„æ˜¾ç¤ºè®¢å• -->
      <view 
        class="customer-orders" 
        wx:for="{{groupedOrders}}" 
        wx:key="customerId"
      >
        <view class="customer-order-header">
          <text class="customer-name">{{item.customerName}}</text>
          <text class="order-count">({{item.orders.length}}ä¸ªè®¢å•)</text>
        </view>
        
        <view 
          class="order-item" 
          wx:for="{{item.orders}}" 
          wx:key="orderId"
          wx:for-item="order"
        >
          <view class="order-header">
            <text class="order-title">è®¢å• #{{order.orderNo || index + 1}}</text>
            <text class="order-amount">Â¥{{order.totalAmount}}</text>
          </view>
        
          <!-- è®¢å•å•†å“åˆ—è¡¨ -->
          <view class="order-products">
            <view 
              class="product-item" 
              wx:for="{{order.products}}" 
              wx:key="productId"
              wx:for-item="product"
              wx:for-index="productIndex"
            >
              <image class="product-image" src="{{product.image || '/images/default-product.png'}}" mode="aspectFill" />
              <view class="product-info">
                <text class="product-name">{{product.name}}</text>
                <text class="product-barcode">{{product.barcode}}</text>
              </view>
              <view class="product-details">
                <view class="detail-row">
                  <text class="detail-label">æ•°é‡ï¼š</text>
                  <text class="detail-value">{{product.quantity}}{{product.unit}}</text>
                </view>
                <view class="detail-row">
                  <text class="detail-label">æˆæœ¬ï¼š</text>
                  <text class="detail-value cost">Â¥{{product.cost}}</text>
                </view>
                <view class="detail-row">
                  <text class="detail-label">å”®ä»·ï¼š</text>
                  <text class="detail-value price">Â¥{{product.price}}</text>
                </view>
                <view class="detail-row">
                  <text class="detail-label">å»ºè®®é›¶å”®ä»·ï¼š</text>
                  <text class="detail-value retail">Â¥{{product.retailPrice}}</text>
                </view>
              </view>
              <view class="product-actions" wx:if="{{isEdit}}">
                <text class="edit-btn" bindtap="editOrderProduct" data-order-index="{{order.orderIndex}}" data-product-index="{{productIndex}}">ç¼–è¾‘</text>
                <text class="remove-btn" bindtap="removeOrderProduct" data-order-index="{{order.orderIndex}}" data-product-index="{{productIndex}}">åˆ é™¤</text>
              </view>
            </view>
          </view>
          
          <view class="order-actions" wx:if="{{isEdit}}">
            <text class="add-product-btn" bindtap="addProductToOrder" data-order-index="{{order.orderIndex}}">+ æ·»åŠ å•†å“</text>
            <text class="remove-order-btn" bindtap="removeOrder" data-order-index="{{order.orderIndex}}">åˆ é™¤è®¢å•</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:elif="{{isEdit}}">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">æš‚æ— è®¢å•</text>
      <text class="empty-subtext">è¯·å…ˆé€‰æ‹©å®¢æˆ·ï¼Œç„¶åæ·»åŠ è®¢å•</text>
    </view>
  </view>

  <!-- é…é€å‘˜é€‰æ‹© -->
  <view class="section" wx:if="{{isEdit}}">
    <view class="section-header">
      <text class="section-title">é…é€å‘˜</text>
    </view>
    <picker 
      class="employee-picker"
      mode="selector"
      range="{{employees}}"
      range-key="name"
      value="{{employeeIndex}}"
      bindchange="onEmployeeChange"
    >
      <view class="picker-text">
        {{employees[employeeIndex].name || 'è¯·é€‰æ‹©é…é€å‘˜'}}
      </view>
    </picker>
  </view>

  <!-- å¤‡æ³¨ä¿¡æ¯ -->
  <view class="section" wx:if="{{isEdit}}">
    <view class="section-header">
      <text class="section-title">å¤‡æ³¨</text>
    </view>
    <textarea 
      class="remark-input"
      placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"
      value="{{remark}}"
      bindinput="onRemarkInput"
      maxlength="200"
    />
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-section" wx:if="{{!isEdit && deliveryId}}">
    <button class="btn btn-primary" bindtap="confirmDelivery" wx:if="{{delivery.status === 'pending'}}">ç¡®è®¤é€è´§</button>
    <button class="btn btn-danger" bindtap="deleteDelivery">åˆ é™¤é€è´§å•</button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- å®¢æˆ·é€‰æ‹©å¼¹çª— -->
<view class="modal" wx:if="{{showCustomerModal}}">
  <view class="modal-mask" bindtap="hideCustomerSelector"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å®¢æˆ·</text>
      <text class="modal-close" bindtap="hideCustomerSelector">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="customer-search">
        <input 
          class="search-input" 
          placeholder="æœç´¢å®¢æˆ·å§“åæˆ–ç”µè¯" 
          value="{{customerSearchKeyword}}"
          bindinput="onCustomerSearchInput"
        />
      </view>
      <view class="customer-options">
        <view 
          class="customer-option" 
          wx:for="{{filteredCustomers}}" 
          wx:key="id"
          bindtap="selectCustomer"
          data-customer="{{item}}"
        >
          <text class="customer-name">{{item.name}}</text>
          <text class="customer-phone">{{item.phone}}</text>
          <text class="customer-address">{{item.address}}</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- è®¢å•åˆ›å»ºå¼¹çª— -->
<view class="modal" wx:if="{{showOrderModal}}">
  <view class="modal-mask" bindtap="hideOrderCreator"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">åˆ›å»ºè®¢å•</text>
      <text class="modal-close" bindtap="hideOrderCreator">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="order-customer-select">
        <text class="select-label">é€‰æ‹©å®¢æˆ·ï¼š</text>
        <picker 
          mode="selector"
          range="{{selectedCustomers}}"
          range-key="name"
          value="{{selectedCustomerIndex}}"
          bindchange="onSelectedCustomerChange"
        >
          <view class="picker-text">
            {{selectedCustomers[selectedCustomerIndex].name || 'è¯·é€‰æ‹©å®¢æˆ·'}}
          </view>
        </picker>
        <text class="customer-order-count">
          (å·²æœ‰{{getCustomerOrderCount(selectedCustomers[selectedCustomerIndex]._id)}}ä¸ªè®¢å•)
        </text>
      </view>
      <view class="order-products-section">
        <view class="section-header">
          <text class="section-title">å•†å“åˆ—è¡¨</text>
          <text class="add-btn" bindtap="showProductSelector">+ æ·»åŠ å•†å“</text>
        </view>
        <view class="order-products-list">
          <view 
            class="order-product-item" 
            wx:for="{{tempOrderProducts}}" 
            wx:key="productId"
          >
            <image class="product-image" src="{{item.image || '/images/default-product.png'}}" mode="aspectFill" />
            <view class="product-info">
              <text class="product-name">{{item.name}}</text>
              <text class="product-barcode">{{item.barcode}}</text>
            </view>
            <view class="product-inputs">
              <view class="input-row">
                <text class="input-label">æ•°é‡ï¼š</text>
                <input 
                  class="quantity-input" 
                  type="number" 
                  value="{{item.quantity}}"
                  bindinput="onQuantityInput"
                  data-index="{{index}}"
                />
                <text class="unit-text">{{item.unit}}</text>
              </view>
              <view class="input-row">
                <text class="input-label">æˆæœ¬ï¼š</text>
                <input 
                  class="cost-input" 
                  type="digit" 
                  value="{{item.cost}}"
                  bindinput="onCostInput"
                  data-index="{{index}}"
                />
              </view>
              <view class="input-row">
                <text class="input-label">å”®ä»·ï¼š</text>
                <input 
                  class="price-input" 
                  type="digit" 
                  value="{{item.price}}"
                  bindinput="onPriceInput"
                  data-index="{{index}}"
                />
              </view>
              <view class="input-row">
                <text class="input-label">å»ºè®®é›¶å”®ä»·ï¼š</text>
                <input 
                  class="retail-input" 
                  type="digit" 
                  value="{{item.retailPrice}}"
                  bindinput="onRetailPriceInput"
                  data-index="{{index}}"
                />
              </view>
            </view>
            <view class="product-actions">
              <text class="remove-btn" bindtap="removeTempProduct" data-index="{{index}}">åˆ é™¤</text>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-secondary" bindtap="hideOrderCreator">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="confirmOrder">ç¡®è®¤è®¢å•</button>
      </view>
    </view>
  </view>
</view>

<!-- å•†å“é€‰æ‹©å¼¹çª— -->
<view class="modal" wx:if="{{showProductModal}}">
  <view class="modal-mask" bindtap="hideProductSelector"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å•†å“</text>
      <text class="modal-close" bindtap="hideProductSelector">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="product-search">
        <input 
          class="search-input" 
          placeholder="æœç´¢å•†å“åç§°æˆ–æ¡å½¢ç " 
          value="{{productSearchKeyword}}"
          bindinput="onProductSearchInput"
        />
      </view>
      <view class="product-options">
        <view 
          class="product-option" 
          wx:for="{{filteredProducts}}" 
          wx:key="id"
          bindtap="selectProduct"
          data-product="{{item}}"
        >
          <image class="product-image" src="{{item.image || '/images/default-product.png'}}" mode="aspectFill" />
          <view class="product-info">
            <text class="product-name">{{item.name}}</text>
            <text class="product-barcode">{{item.barcode}}</text>
            <text class="product-price">æˆæœ¬ï¼šÂ¥{{item.cost}} | å”®ä»·ï¼šÂ¥{{item.price}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view> 
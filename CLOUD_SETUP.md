# 云函数配置说明

## 1. 项目配置文件设置

### 1.1 project.config.json 配置
在 `project.config.json` 文件中添加云函数根目录配置：

```json
{
  "cloudfunctionRoot": "cloudfunctions/"
}
```

这个配置告诉微信开发者工具 `cloudfunctions/` 文件夹是云函数目录。

## 2. 云开发环境配置

### 2.1 在 app.js 中初始化云开发
```javascript
onLaunch() {
  // 初始化云开发
  if (!wx.cloud) {
    console.error('请使用 2.2.3 或以上的基础库以使用云能力')
  } else {
    wx.cloud.init({
      env: 'your-env-id', // 替换为你的云开发环境ID
      traceUser: true,
    })
  }
}
```

### 2.2 获取云开发环境ID
1. 登录微信公众平台
2. 进入小程序后台
3. 点击"开发" -> "开发管理" -> "云开发"
4. 在云开发控制台中找到环境ID

### 2.3 解决"请在编辑器云函数根目录选择一个云环境"错误

#### 步骤1：开启云开发
1. 在微信开发者工具中，点击工具栏的"云开发"按钮
2. 如果是第一次使用，会提示开通云开发
3. 点击"开通"并完成实名认证

#### 步骤2：创建云环境
1. 在云开发控制台中，点击"创建环境"
2. 输入环境名称（如：`supplier-app-prod`）
3. 选择付费方式（可以选择免费版本）
4. 点击"确定"创建环境

#### 步骤3：选择云环境
1. 在微信开发者工具中，点击工具栏的"云开发"按钮
2. 在云开发面板中，点击右上角的"环境选择"
3. 选择您刚创建的云环境
4. 确认选择

#### 步骤4：配置项目云环境
1. 在微信开发者工具中，点击"详情" -> "本地设置"
2. 找到"云开发"选项
3. 选择您创建的云环境
4. 点击"确定"保存

#### 步骤5：更新 app.js 中的环境ID
将 `app.js` 中的 `'your-env-id'` 替换为实际的云环境ID：

```javascript
wx.cloud.init({
  env: 'supplier-app-prod-xxxxx', // 替换为您的实际环境ID
  traceUser: true,
})
```

#### 步骤6：验证配置
1. 在微信开发者工具中，右键点击 `cloudfunctions` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 如果不再报错，说明配置成功

## 3. 云函数目录结构

```
cloudfunctions/
├── login/              # 登录云函数
│   ├── index.js
│   └── package.json
├── delivery/           # 送货单管理云函数
│   ├── index.js
│   └── package.json
├── product/            # 商品管理云函数
│   ├── index.js
│   └── package.json
├── customer/           # 客户管理云函数
│   ├── index.js
│   └── package.json
├── employee/           # 员工管理云函数
│   ├── index.js
│   └── package.json
└── statistics/         # 统计云函数
    ├── index.js
    └── package.json
```

## 4. 云函数调用方式

### 4.1 直接调用云函数
```javascript
wx.cloud.callFunction({
  name: 'login',
  data: {
    phone: '13800138000',
    password: '123456'
  },
  success: res => {
    console.log('调用成功:', res.result)
  },
  fail: err => {
    console.error('调用失败:', err)
  }
})
```

### 4.2 使用封装的 request 方法
```javascript
// 在 app.js 中已经封装了通用的 request 方法
app.request({
  url: '/delivery/getDeliveries',
  data: {
    page: 1,
    pageSize: 20
  }
}).then(res => {
  console.log('获取送货单列表:', res.data)
}).catch(err => {
  console.error('请求失败:', err)
})
```

## 5. 云函数部署步骤

### 5.1 在微信开发者工具中
1. 确保项目配置了 `cloudfunctionRoot`
2. 确保已选择云环境
3. 右键点击 `cloudfunctions` 文件夹
4. 选择"上传并部署：云端安装依赖"
5. 等待所有云函数部署完成

### 5.2 检查部署状态
1. 在微信开发者工具中点击"云开发"
2. 查看云函数列表，确保所有函数都已部署
3. 检查云函数的状态是否为"正常"

## 6. 云函数调试

### 6.1 本地调试
1. 在云函数目录下运行 `npm install`
2. 在微信开发者工具中右键点击云函数
3. 选择"本地调试"

### 6.2 云端调试
1. 在云开发控制台中
2. 选择"云函数"
3. 点击函数名称进入详情
4. 在"测试"标签页中进行测试

## 7. 常见问题

### 7.1 云函数调用失败
- 检查云函数是否已部署
- 检查环境ID是否正确
- 检查云函数名称是否正确

### 7.2 数据库访问失败
- 检查云函数是否有数据库访问权限
- 检查数据库集合是否存在
- 检查数据库权限设置

### 7.3 依赖安装失败
- 检查 package.json 文件是否正确
- 检查网络连接
- 尝试重新部署云函数

### 7.4 "请在编辑器云函数根目录选择一个云环境"错误
**解决方案：**
1. 确保已开通云开发服务
2. 创建云环境并选择
3. 在项目详情中配置云环境
4. 更新 app.js 中的环境ID
5. 重新部署云函数

## 8. 环境变量配置

### 8.1 在云开发控制台中
1. 进入云开发控制台
2. 选择"设置" -> "环境设置"
3. 配置环境变量（如数据库连接等）

### 8.2 在云函数中使用
```javascript
// 在云函数中获取环境变量
const env = process.env.NODE_ENV
```

## 9. 性能优化

### 9.1 云函数优化
- 合理使用数据库索引
- 避免在云函数中进行复杂计算
- 使用连接池管理数据库连接

### 9.2 调用优化
- 批量处理数据
- 使用缓存减少重复请求
- 合理设置超时时间

## 10. 安全配置

### 10.1 数据库权限
- 设置合适的数据库访问权限
- 使用云函数进行数据操作，避免直接暴露数据库

### 10.2 云函数权限
- 设置云函数的访问权限
- 使用环境变量存储敏感信息
- 定期更新依赖包 